#!/usr/bin/env ruby
# frozen_string_literal: true

$LOAD_PATH.unshift(File.expand_path('../lib', __dir__))
require 'agent_seo'
require 'json'
require 'optparse'

options = {}

OptionParser.new do |opts|
  opts.banner = 'Usage: seo-readability [options]'
  opts.separator ''
  opts.separator 'Analyze content readability using multiple scoring algorithms.'
  opts.separator ''
  opts.separator 'Options:'

  opts.on('-f', '--file FILE', 'Content file to analyze (reads from stdin if not provided)') do |f|
    options[:file] = f
  end

  opts.on('--json', 'Output as JSON') do
    options[:json] = true
  end

  opts.on('-h', '--help', 'Show this help message') do
    puts opts
    exit
  end
end.parse!

begin
  content = if options[:file]
              File.read(options[:file])
            elsif !$stdin.tty?
              $stdin.read
            else
              warn 'Error: No content provided. Use -f FILE or pipe content to stdin.'
              exit 1
            end
rescue Errno::ENOENT => e
  warn "Error: #{e.message}"
  exit 1
end

scorer = AgentSeo::ReadabilityScorer.new
result = scorer.analyze(content)

if result[:error]
  warn "Error: #{result[:error]}"
  exit 1
end

if options[:json]
  puts JSON.pretty_generate(result)
else
  puts 'Readability Analysis Results'
  puts '=' * 50
  puts ''
  puts "Overall Score: #{result[:overall_score]}/100 (Grade: #{result[:grade]})"
  puts "Reading Level: Grade #{result[:reading_level]}"
  puts ''

  metrics = result[:readability_metrics]
  puts 'Readability Metrics:'
  puts "  Flesch Reading Ease: #{metrics[:flesch_reading_ease]} (higher = easier)"
  puts "  Flesch-Kincaid Grade: #{metrics[:flesch_kincaid_grade]}"
  puts "  Gunning Fog Index: #{metrics[:gunning_fog]}"
  puts "  SMOG Index: #{metrics[:smog_index]}"
  puts "  Coleman-Liau Index: #{metrics[:coleman_liau_index]}"
  puts ''

  structure = result[:structure_analysis]
  puts 'Structure Analysis:'
  puts "  Total Words: #{structure[:total_words]}"
  puts "  Total Sentences: #{structure[:total_sentences]}"
  puts "  Average Sentence Length: #{structure[:avg_sentence_length]} words"
  puts "  Longest Sentence: #{structure[:longest_sentence]} words"
  puts "  Total Paragraphs: #{structure[:total_paragraphs]}"
  puts "  Avg Sentences/Paragraph: #{structure[:avg_sentences_per_paragraph]}"
  puts ''

  complexity = result[:complexity_analysis]
  puts 'Complexity Analysis:'
  puts "  Transition Words: #{complexity[:transition_word_count]}"
  puts "  Passive Voice: #{complexity[:passive_sentence_ratio]}% of sentences"
  puts "  Complex Words (3+ syllables): #{complexity[:complex_word_ratio]}%"
  puts ''

  status = result[:status]
  puts 'Status:'
  puts "  Grade Level: #{status[:grade_level_status]}"
  puts "  Ease: #{status[:ease_status]}"
  puts "  Sentence Length: #{status[:sentence_length_status]}"
  puts "  Overall: #{status[:overall_assessment]}"
  puts ''

  if result[:recommendations].any?
    puts 'Recommendations:'
    result[:recommendations].each { |r| puts "  - #{r}" }
  end
end
